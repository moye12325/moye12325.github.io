# GitHub Pages + Hexo 博客主题显示问题排查总结

## 问题现象

- **本地访问**：✅ 正常，主题显示正确
- **远程访问**（GitHub Pages）：❌ 显示默认主题，而不是配置的 redefine 主题

## 根本原因分析

### 🔴 主要问题：错误的 CNAME 配置

在 `.github/workflows/deploy.yml` 文件的第 55 行：

```yaml
cname: moye12325.github.io  # ❌ 错误配置！
```

#### 为什么这是错误的？

1. **CNAME 的真正用途**：
   - CNAME 文件用于配置**自定义域名**
   - 例如：`www.example.com`、`blog.example.com` 等购买的域名
   
2. **你的实际情况**：
   - 使用的是 GitHub 默认域名：`https://moye12325.github.io`
   - 这是 GitHub Pages 提供的免费域名，**不是**自定义域名
   - 因此**不需要** CNAME 文件

3. **错误配置的后果**：
   - 部署时会在 `gh-pages` 分支创建 CNAME 文件
   - GitHub Pages 误以为你要使用自定义域名
   - 导致 DNS 解析混乱
   - 可能造成资源加载失败、样式丢失等问题

### 🟡 次要问题：缺少主题验证

原工作流没有验证主题是否正确安装，如果 `npm ci` 安装依赖时主题安装失败，构建会静默使用降级方案。

## 解决方案

### 1. 移除错误的 CNAME 配置

**修改前：**
```yaml
- name: Deploy to GitHub Pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: ./public
    publish_branch: gh-pages
    cname: moye12325.github.io  # ❌ 删除这一行
```

**修改后：**
```yaml
- name: Deploy to GitHub Pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: ./public
    publish_branch: gh-pages
    # ✅ 已移除 CNAME 配置
```

### 2. 添加主题安装验证步骤

在构建之前添加验证：

```yaml
- name: Verify Theme Installation
  run: |
    echo "=== Checking installed themes ==="
    ls -la node_modules/ | grep hexo-theme || echo "No themes found in node_modules"
    if [ -d "node_modules/hexo-theme-redefine" ]; then
      echo "✓ hexo-theme-redefine is installed"
    else
      echo "✗ hexo-theme-redefine is NOT installed"
      exit 1
    fi
```

### 3. 增强构建输出检查

```yaml
- name: Check Build Output
  run: |
    echo "=== Build Output Directory ==="
    ls -la public/ | head -20
    echo "=== Total Files ==="
    find public -type f | wc -l
    echo "=== Checking for index.html ==="
    test -f public/index.html && echo "✓ index.html found" || echo "✗ index.html NOT found"
    echo "=== Checking theme assets ==="
    if [ -d "public/css" ] && [ -d "public/js" ]; then
      echo "✓ Theme assets found"
    else
      echo "✗ Theme assets NOT found"
    fi
```

## 部署步骤

### Step 1: 提交修改

```bash
# 查看修改
git status

# 添加修改的文件
git add .github/workflows/deploy.yml
git add scripts/README_SCRIPTS.md  # 重命名了 scripts/README.md 避免被当作 Hexo 脚本加载

# 提交
git commit -m "fix: 修复 GitHub Pages 部署问题 - 移除错误的 CNAME 配置"

# 推送到 main 分支
git push origin main
```

### Step 2: 监控 GitHub Actions

1. 访问你的 GitHub 仓库
2. 点击 **Actions** 标签页
3. 查看最新的工作流运行
4. 确保所有步骤都通过（绿色 ✓）
5. 特别关注新增的 "Verify Theme Installation" 步骤

### Step 3: 检查并清理 gh-pages 分支

```bash
# 切换到 gh-pages 分支
git checkout gh-pages

# 拉取最新代码
git pull origin gh-pages

# 检查是否还有 CNAME 文件
ls -la | grep CNAME

# 如果存在 CNAME 文件，删除它
git rm CNAME
git commit -m "chore: 移除错误的 CNAME 文件"
git push origin gh-pages

# 切回主分支
git checkout main
```

### Step 4: 验证 GitHub Pages 设置

1. 访问仓库 **Settings** > **Pages**
2. 确认配置：
   - **Source**: Branch: `gh-pages`, Folder: `/ (root)`
   - **Custom domain**: 应该是**空白**的（不要填写任何内容）
3. 如果 Custom domain 字段有内容，清空它并保存

### Step 5: 等待部署完成

- GitHub Pages 部署通常需要 **1-3 分钟**
- 可以在 Settings > Pages 页面看到部署状态
- 看到 "Your site is live at https://moye12325.github.io" 表示部署成功

### Step 6: 访问并验证

访问 `https://moye12325.github.io`，检查：
- ✅ 主题颜色是否正确（红色主题色 #A31F34）
- ✅ 网站标题是否为"码农修行手册"
- ✅ 副标题是否为"Python与量子计算之路上的心得与实践"
- ✅ 头像和 favicon 是否显示
- ✅ 导航栏是否正常（博客、随笔、项目、友链、关于）

## 其他修复

### 修复 scripts 目录问题

**问题**：`scripts/README.md` 被 Hexo 当作脚本加载导致错误

**解决**：将 `scripts/README.md` 重命名为 `scripts/README_SCRIPTS.md`

```bash
mv scripts/README.md scripts/README_SCRIPTS.md
```

## 如果将来需要使用自定义域名

如果你购买了自定义域名（例如 `www.myblog.com`），那么：

### 1. 配置 DNS

在你的域名提供商（如阿里云、腾讯云、Cloudflare）处添加：

- **类型**：CNAME
- **名称**：www（或 @）
- **值**：moye12325.github.io

### 2. 修改 GitHub Actions

在 `.github/workflows/deploy.yml` 中恢复 CNAME 配置：

```yaml
- name: Deploy to GitHub Pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: ./public
    publish_branch: gh-pages
    cname: www.myblog.com  # ✅ 使用你的实际自定义域名
```

### 3. 在 GitHub 仓库中配置

- 访问 Settings > Pages
- 在 Custom domain 字段输入：`www.myblog.com`
- 勾选 "Enforce HTTPS"

## 预期结果

修复后，你的博客应该：

1. ✅ 远程访问时正确显示 redefine 主题
2. ✅ 所有样式、字体、图片正常加载
3. ✅ 主题配置（颜色、导航、布局等）完全生效
4. ✅ 与本地预览效果一致

## 技术说明

### 为什么本地正常而远程不正常？

- **本地环境**：直接使用 `localhost` 或 `127.0.0.1`，没有域名相关的问题
- **GitHub Pages**：涉及域名解析、HTTPS 证书、资源路径等复杂配置
- **CNAME 配置错误**会导致：
  - DNS CNAME 循环
  - 资源路径计算错误
  - HTTPS 证书验证失败
  - 最终导致样式丢失、显示默认主题

### Hexo 主题加载机制

1. Hexo 从 `_config.yml` 读取 `theme: redefine`
2. 按以下顺序查找主题：
   - `themes/redefine/` 目录
   - `node_modules/hexo-theme-redefine/` 目录
3. 如果找不到主题，会回退到默认主题（landscape）

你的项目通过 npm 安装主题（`package.json` 中的依赖），因此主题位于 `node_modules/` 中，这是推荐的现代做法。

## 总结

**核心问题**：错误地为 GitHub 默认域名配置了 CNAME

**解决方案**：移除 CNAME 配置，添加主题验证步骤

**影响**：修复后，远程部署的博客将正确显示 redefine 主题，与本地预览完全一致
